<script src="/Socket.IO-node/example/client/socket.io.js"></script>

<script>
io.setPath('/Socket.IO-node/example/client/');

var socket = new io.Socket(null, {port: 8125}); //todo: get the port from location
socket.connect();
socket.on('message', function(obj){
  applyDelta(obj.id, obj)
});

var msgs = {};
function applyDelta(id, delta){
	if(!(id in msgs)){
			loadMessage(id)
	}
		
	//console.log('got delta',delta)
	
	var msg = msgs[id];
	
	if(delta.v < msg.v) return;
	
	if(delta.acl){
		for(var i in delta.acl){
			msg.acl[i] = msg.acl[i] || {};
			for(var k in delta.acl[i])
				msg.acl[i][k] = delta.acl[i][k];
		}
	}
	
	if(delta.data){
		for(var i in delta.data){
			msg.data[i] = msg.data[i] || {};
			for(var k in delta.data[i])
				msg.data[i][k] = delta.data[i][k];
		}
	}
	
	if(delta.add_children){
		//TODO: support Reordering
		msg.children = msg.children.concat(delta.add_children);
		for(var i = 0; i < delta.add_children.length; i++){
			var ci = delta.add_children[i]
			loadMessage(ci);
			document.getElementById(id).threadel.appendChild(renderMsg(ci));
		}
	}
	
	//A *very* basic totally not working real OT that will have
	//TONS OF COLLISIONS. DO NOT USE THIS IN ANYTHING OTHER THAN
	//A PROTOTYPE!
	if(delta.ot){
		for(var i = 0, l = delta.ot.length; i < l; i++){
			var r = delta.ot[i]; //[14, 18, "gray"]
			msg.text = msg.text.substr(0,r[0]) + r[2] + msg.text.substr(r[1]);
		}
	}
	
	msg.time = delta.time;
	msg.v = delta.v; //increment version
	//console.log(msg.text)
	
	var ed = document.getElementById(id);
	if(ed.editor.contentEditable == 'false'){
	 //ed.editor.innerText = msg.text;
		change_dynamic(ed.editor, msg.text, dynamic_renderer)
	}
	
	ed.header.innerText = id+' v'+msgs[id].v+' '+format_time(msgs[id].time);
}

function format_time(ts){
	var t = new Date;
	t.setTime(ts);
	if(t.toString().indexOf('Invalid') == 0) return 'Never';
	return t.getMonth() + '/' + t.getDate() + ' ' + t.getHours() + ':' + t.getMinutes() + ':' + t.getSeconds();
}

function update(id, diff){
	socket.send({
	  op: {
	    id: id,
	    v: msgs[id].v+1,
  		ot: [diff]
	  }
	})
}


function listen(url){
	socket.send({
	  add: url
  })
}


/* 
//awesome diff algorithm that i didnt make
function diff(a, b){	
  var al = a.length, bl = b.length, s = -1, e = -1;
	var shortest = (b.length > a.length) ? a.length : b.length;
	
	var i = 0;
	for (; i < shortest; i++) {
		if(a[i] != b[i]) break;
	}
	
	var j = 0;
	for(; j < shortest - i; j++) {
		if(a[al-j] != b[bl-j]) break;
	}
	
	console.log(i,j)
	
  return [i,al-j +1,b.substring(i,bl-j+1)]
}

function undiff(text, r){
	return text.substr(0,r[0]) + r[2] + text.substr(r[1]);
}

*/


function diff(a, b){
	var al = a.length, bl = b.length, shortest = Math.min(bl, al), i = 0, j = 0;
	while(i < shortest && a[i] == b[i]) i++;
	while(j < shortest - i && a[al-j] == b[bl-j]) j++;
  return [i,al-j + 1,b.substring(i,bl-j+1)]
}


function loadMessage(id){
	//todo: make async
	var xhr = new XMLHttpRequest();
	xhr.open('GET','/loadmsg?url='+encodeURIComponent(id), false);
	xhr.send(null);
	var j = JSON.parse(xhr.responseText);
	//j.history = [];
	msgs[id] = j;
	listen(id);
}


function change_dynamic(node, v2, handler){
	var tmp = document.createElement('div');
	var name_map = {};
	for(var el, els = node.getElementsByClassName('_dyn'); el = els[0];){
		name_map[el.getAttribute('name')] = el;
		tmp.appendChild(el);
	}
	node.innerHTML = v2;
	for(var els = node.getElementsByClassName('_dyn'), l = els.length; l--;){
		var matching_el = name_map[els[l].getAttribute('name')];
		if(matching_el){
			els[l].parentNode.replaceChild(matching_el, els[l]);
		}else{
			handler(els[l]);
		}
	}
}



function html_dynamic(el){
	var html = el.innerHTML;
	for(var els = el.getElementsByClassName('_dyn'), l = els.length; l--;){
		html = html.replace(els[l].innerHTML, '')
	}
	return html.replace(/&nbsp;$/,' ');
}

function dynamic_renderer(el){
	var tn = el.tagName.toLowerCase();
	var en = el.getAttribute('name')
	if(tn == 'message'){
		el.appendChild(renderMsg(en))
	}else{
		el.innerHTML = 'YAY POOP'
	}
}


function renderMsg(id){
	/*
		WARNING:
		these closures are probably prone to memory leaks. FIX IT.
	*/
	if(!(id in msgs)) loadMessage(id);
	
	var d = document.createElement('div');
	d.contentEditable = 'false';
	
	var t = document.createElement('div');
	change_dynamic(t, msgs[id].text, dynamic_renderer);
	
	var hdr = document.createElement('span');
	hdr.className = 'header'
	
	
	hdr.innerText = id+' v'+msgs[id].v+' '+format_time(msgs[id].time);
	d.header = hdr;
	d.appendChild(hdr)
	d.editor = t;
	
	t.className = 'text'
	
	d.id = id;


	var be = document.createElement('button');
	var toggle_edit = function(){
		if(t.contentEditable = t.contentEditable == 'false'){
			be.innerText = 'Done'
			t.focus();
		}else{
			be.innerText = 'Edit'
		}
	}
	be.onclick = toggle_edit;
	be.innerText = 'Edit'
	d.appendChild(be)
  var check_updates;
	var b = document.createElement('button');
	b.onclick = function(){
		var nid = 'http://localhost:8124/'+Math.random().toString(36).substr(2,3);
							//obviously, 3 characters provides nowhere near enough entropy
							//in a production environment.
		var hd = html_dynamic(t);
		var reg;
		var msg = '<message class="_dyn" name="'+nid+'"></message>';

		hd += '<div class="thread"><thread>'+msg+'</thread></div>'
		console.log('replying stuff',hd);
		change_dynamic(t, hd, dynamic_renderer);
		console.log(t.innerHTML)
		t.contentEditable = 'true';
		check_updates();
		setTimeout(function(){
  		t.contentEditable = 'false';
		},100);
	}
	b.innerText = 'Reply'
	d.appendChild(b)
	
	
	var c = document.createElement('button');
	c.onclick = function(){
		var nid = 'http://localhost:8124/'+Math.random().toString(36).substr(2,3);
							//obviously, 3 characters provides nowhere near enough entropy
							//in a production environment.
							
	  var thread = d.parentNode.parentNode;
	  var msg = document.createElement('message');
	  msg.className = '_dyn';
	  msg.setAttribute('name', nid);
	  thread.appendChild(msg);
	  dynamic_renderer(msg);
	  
	  
	  var pm = thread.parentNode;
	  while(pm.className != 'message'){
	    pm = pm.parentNode;
	  }
	  
		pm.editor.contentEditable = 'true';
		pm.check_updates();
		setTimeout(function(){
  		pm.editor.contentEditable = false;
		},100);
	}
	c.innerText = 'Continue'
	
	
	d.appendChild(c)
	
	
	/*
	var t2 = document.createElement('div');
	t2.innerText = msgs[id].text;
	d.editor = t2;
	t2.className = 't2_temp'
	d.appendChild(t2)
	//*/
	var lasttext = '';
	
	
	
	d.check_updates = check_updates = function(){
	
		if(!t.parentNode || t.contentEditable == 'false'){
			return 
		}
		
		var hd = html_dynamic(t)
		if(msgs[id].text == hd){
			return
		}
		
		var delta = diff(msgs[id].text, hd) //TODO: something smarter
		
		console.log('Loaded Version', id, msgs[id].v, 'diff', delta)


	 window.Z = d;
	 
	 
	 
		if(msgs[id].text != lasttext && lasttext != ''){
  		lasttext = hd;
			console.log('odd sync mismatch', lasttext, 'VERSUS', msgs[id].text)
			loadMessage(id)
			
			return 'delay'
		}
		
		lasttext = hd;
		
		update(id, delta);
	};
	
	var looper;
	setTimeout(looper = function(){
	  var res = check_updates();
	  if(res == 'delay'){
	    setTimeout(looper, 4000);
	  }else{
	    setTimeout(looper, 100);
	  }
	},100)
	
	

	
	d.appendChild(t)
	d.className = 'message'
	
	return d
}

function render(id){
  var parent = document.getElementById('main');
	parent.innerHTML = '';
	if(!(id in msgs)) loadMessage(id);
	var msg = msgs[id];
	var el = renderMsg(id);
	parent.appendChild(el)
}

</script>
<style>
	.text{
		min-height: 30px;
	}
	
	* {
		font-family:  helvetica, sans-serif;
		font-size: small;
		
	}
	
	
	.header {
		border-bottom: 1px solid #77dd77;
	}
	
	.t2_temp {
		font-family: monospace;
		padding: 10px;
	}
	
	.message {
		border-top: 1px solid gray;
	}
	
	
	
	.thread {
		padding-left: 3px;
		margin-top: 10px;
		margin-left: 10px;
		border-left: 3px solid #007fff;
	}
	
</style>
<form onsubmit="var v=this.root.value;setTimeout(function(){render(v)},0);return false">
	<input type='text' name='root' value='http://localhost:8124/supertestparent' style="width:500px" autofocus>
</form>
<div id="main">
</div>
