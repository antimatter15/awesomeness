<script>
var msgs = {};
function applyDelta(id, delta){
	if(!(id in msgs)){
			loadMessage(id)
	}
		
	console.log('got delta',delta)
	
	var msg = msgs[id];
	
	if(delta.v < msg.v) return;
	
	if(delta.acl){
		for(var i in delta.acl){
			msg.acl[i] = msg.acl[i] || {};
			for(var k in delta.acl[i])
				msg.acl[i][k] = delta.acl[i][k];
				
		}
	}
	
	if(delta.elements){
		for(var i in delta.elements){
			msg.elements[i] = msg.elements[i] || {};
			for(var k in delta.elements[i])
				msg.elements[i][k] = delta.elements[i][k];
		}
	}
	
	if(delta.add_children){
		//TODO: support Reordering
		msg.children = msg.children.concat(delta.add_children);
		for(var i = 0; i < delta.add_children.length; i++){
			var ci = delta.add_children[i]
			loadMessage(ci);
			document.getElementById(id).threadel.appendChild(renderMsg(ci));
		}
	}
	
	//A *very* basic totally not working real OT that will have
	//TONS OF COLLISIONS. DO NOT USE THIS IN ANYTHING OTHER THAN
	//A PROTOTYPE!
	if(delta.ot){
		for(var i = 0, l = delta.ot.length; i < l; i++){
			var r = delta.ot[i]; //[14, 18, "gray"]
			msg.text = msg.text.substr(0,r[0]) + r[2] + msg.text.substr(r[1]);
		}
	}
	
	msg.time = delta.time;
	msg.v = delta.v; //increment version
	//console.log(msg.text)
	
	var ed = document.getElementById(id);
	if(ed.editor.contentEditable == 'false')
	 ed.editor.innerText = msg.text;
	
	var time = new Date;
	time.setTime(msgs[id].time);
	ed.header.innerText = id+' v'+msgs[id].v+' '+time.toString();
	
}

function update(id,diff){
	var xhr = new XMLHttpRequest();
	xhr.open('POST','/',false);
	xhr.send(JSON.stringify({
		id: id,
		v: msgs[id].v+1,
		ot: [diff]
	}));
	console.log(xhr.responseText)
}

function add_child(id){
	var xhr = new XMLHttpRequest();
	xhr.open('POST','/',false);
	xhr.send(JSON.stringify({
		id: id,
		v: msgs[id].v+1,
		add_children: ['http://localhost:8124/'+Math.random().toString(36).substr(2,16)]
	}));
	console.log(xhr.responseText)
}


function listen(url, callback){
	var xhr = new XMLHttpRequest();
	xhr.open('get','/comet/?v='+(msgs[url].v)+'&url='+encodeURIComponent(url), true);
	xhr.onreadystatechange = function(){
		if(xhr.readyState == 4){
			var json = JSON.parse(xhr.responseText);
			console.log(json)
			applyDelta(json.id, json)
			listen(url, callback)
		}
	}
	xhr.send(null)
}
/* //awesome diff algorithm that i didnt make
function diff(a, b){	
  var al = a.length, bl = b.length, s = -1, e = -1;
	var shortest = (b.length > a.length) ? a.length : b.length;
	
	var i = 0;
	for (; i < shortest; i++) {
		if(a[i] != b[i]) break;
	}
	
	var j = 0;
	for(; j < shortest - i; j++) {
		if(a[al-j] != b[bl-j]) break;
	}
	
	console.log(i,j)
	
  return [i,al-j +1,b.substring(i,bl-j+1)]
}

function undiff(text, r){
	return text.substr(0,r[0]) + r[2] + text.substr(r[1]);
}

*/


function diff(a, b){
	var al = a.length, bl = b.length, shortest = Math.min(bl, al), i = 0, j = 0;
	while(i < shortest && a[i] == b[i]) i++;
	while(j < shortest - i && a[al-j] == b[bl-j]) j++;
  return [i,al-j + 1,b.substring(i,bl-j+1)]
}


function loadMessage(id){
	//todo: make async
	var xhr = new XMLHttpRequest();
	xhr.open('GET','/loadmsg?url='+encodeURIComponent(id), false);
	xhr.send(null);
	var j = JSON.parse(xhr.responseText);
	//j.history = [];
	msgs[id] = j;
	listen(id);
}

function parseHTML(html){
	return html.replace(/<message>(.+)<\/message>/g, function(a, msgid){
		
	})
}


function change_dynamic(el, v2, handler){
	var tmp = document.createElement('div');
	var name_map = {};
	for(var els = el.getElementsByClassName('_dyn'), l = els.length; l--;){
		name_map[els[l].getAttribute('name')] = els[l];
		tmp.appendChild(els[l]);
	}
	el.innerHTML = v2;
	for(var els = el.getElementsByClassName('_dyn'), l = els.length; l--;){
		var matching_el = name_map[els[l].getAttribute('name')];
		if(matching_el){
			els[l].parentNode.replaceChild(matching_el, els[l]);
		}else{
			handler(els[l]);
		}
	}
}



function html_dynamic(el){
	var html = el.innerHTML;
	for(var els = el.getElementsByClassName('_dyn'), l = els.length; l--;){
		html = html.replace(els[l].innerHTML, '')
	}
	return html;
}

function dynamic_renderer(el){
	el.innerHTML = 'YAY POOP'
}


function renderMsg(id){
	/*
		WARNING:
		these closures are probably prone to memory leaks. FIX IT.
	*/
	var d = document.createElement('div');
	var t = document.createElement('div');
	change_dynamic(t, msgs[id].text, dynamic_renderer);
	
	var hdr = document.createElement('span');
	var time = new Date;
	time.setTime(msgs[id].time);
	hdr.innerText = id+' v'+msgs[id].v+' '+time.toString();
	d.header = hdr;
	d.appendChild(hdr)
	
	
	t.className = 'text'
	
	var t2 = document.createElement('div');
	t2.innerText = msgs[id].text;
	d.appendChild(t2)
	
	d.id = id;
	d.editor = t2;
	
	var lasttext = '';
	
	setInterval(function(){
		if(!t.parentNode || t.contentEditable == 'false') return false;
		
		var hd = html_dynamic(t)
		
		if(msgs[id].text == hd) return;
		
		var d = diff(msgs[id].text, hd) //TODO: something smarter
		
		console.log('Loaded Version', msgs[id].v)
		
		if(msgs[id].text != lasttext){
			console.log('odd sync mismatch', lasttext, msgs[id].text)
		}
		
		lasttext = hd;
		
		update(id, d)
	},100)
	
	var b = document.createElement('button');
	b.onclick = function(){
		t.contentEditable = t.contentEditable == 'false';
	}
	b.innerText = 'Toggle Edit'
	d.appendChild(b)

	var b = document.createElement('button');
	b.onclick = function(){
		add_child(id)
	}
	b.innerText = 'Reply'
	d.appendChild(b)
	
	
	d.appendChild(t)
	d.className = 'message'
	
	
	return d
}

function render(id){
  var parent = document.getElementById('main');
	parent.innerHTML = '';
	if(!(id in msgs)) loadMessage(id);
	var msg = msgs[id];
	var el = renderMsg(id);
	parent.appendChild(el)
}

</script>
<style>
	.text{
		background-color: #f0f0f0;
		min-height: 50px;
	}
	
	.text[contentEditable=true]{
		background-color: #e0e0ff;
	}
	
	.thread {
		padding-left: 30px;
		border-left: 3px solid #007fff;
	}
	
</style>
<form onsubmit="var v=this.root.value;setTimeout(function(){render(v)},0);return false">
	<input type='text' name='root' value='http://localhost:8124/supertestparent' style="width:500px" autofocus>
</form>
<div id="main">
</div>